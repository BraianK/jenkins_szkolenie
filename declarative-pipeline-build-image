pipeline {
    agent none
    
    options{
        timestamps()
    }
    
	environment {
        githubCredentialsID = "github-access-credentials-braian-k"
        python_app_git_repo = "https://github.com/devopsit-mg/python-app-k8s.git"
        CONTAINER_REGISTRY = "ghcr.io"
        IMAGE_WORKSPACE = "dgerwatowski-git"
        IMAGE_NAME = "python-app"
        IMAGE_VERSION = 1.0
        IMAGE_PATH = "$CONTAINER_REGISTRY/$IMAGE_WORKSPACE/$IMAGE_NAME:$IMAGE_VERSION"

    }
    stages{
        stage('clone repo'){
            agent {
                docker { 
                    image 'alpine:3.6' 
                    label 'slave01' 
                    reuseNode true 
                }
            } 
            steps{
                git branch: 'main', credentialsId: 'github-access-credentials-dgerwatowski', url: 'https://github.com/devopsit-mg/python-app-k8s.git', poll: true, changelog: true
            }     
        }
        stage("Build image") {
            agent { label 'slave01' }
            steps {
              withCredentials([usernamePassword(credentialsId: env.githubCredentialsID, usernameVariable: 'username', passwordVariable: 'password')])
              {
                  sh "docker login -u $username -p $password $CONTAINER_REGISTRY"
              }
              sh "docker build . -t $IMAGE_PATH"
              sh "docker push $IMAGE_PATH"
            }

        }
    }
}
